From f81cd7732c9ee920b054762eae107cff8126f3df Mon Sep 17 00:00:00 2001
Message-Id: <f81cd7732c9ee920b054762eae107cff8126f3df.1424982292.git.jen@redhat.com>
From: Alex Williamson <alex.williamson@redhat.com>
Date: Wed, 25 Feb 2015 19:01:48 -0500
Subject: [CHANGE 1/3] Add support for local configuration files
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
To: rhvirt-patches@redhat.com,
    jen@redhat.com

RH-Author: Alex Williamson <alex.williamson@redhat.com>
Message-id: <20150225190148.17227.88828.stgit@gimli.home>
Patchwork-id: 63938
O-Subject: [RHEL6.7 gpxe PATCH 1/3] [build] Add support for local configuration files
Bugzilla: 968474
RH-Acked-by: Jeff Nelson <jenelson@redhat.com>
RH-Acked-by: Laszlo Ersek <lersek@redhat.com>
RH-Acked-by: Gerd Hoffmann <kraxel@redhat.com>

From: Piotr Jaroszy≈Ñski <p.jaroszynski@gmail.com>

Bugzilla: 968474
Upstream: 46d6ec7d77a041d8266d0d9811f57ba92e86599e
Notes: Dropped src/config/local/.gitignore, we own local config

Include config/local/$file in config/$file where it makes sense and
create empty local configs during build if not present.

Modified-by: Michael Brown <mcb30@etherboot.org>
Signed-off-by: Michael Brown <mcb30@etherboot.org>
---
 src/.gitignore            |    1 -
 src/Makefile.housekeeping |    9 ++++++++-
 src/config/console.h      |    2 ++
 src/config/general.h      |    2 ++
 src/config/ioapi.h        |    2 ++
 src/config/isa.h          |    2 ++
 src/config/nap.h          |    2 ++
 src/config/serial.h       |    2 ++
 src/config/timer.h        |    2 ++
 src/config/umalloc.h      |    2 ++
 10 files changed, 24 insertions(+), 2 deletions(-)

Signed-off-by: Jeff E. Nelson <jen@redhat.com>
---
 src/.gitignore            | 1 -
 src/Makefile.housekeeping | 9 ++++++++-
 src/config/console.h      | 2 ++
 src/config/general.h      | 2 ++
 src/config/ioapi.h        | 2 ++
 src/config/isa.h          | 2 ++
 src/config/nap.h          | 2 ++
 src/config/serial.h       | 2 ++
 src/config/timer.h        | 2 ++
 src/config/umalloc.h      | 2 ++
 10 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/src/.gitignore b/src/.gitignore
index 413f814..cc8e33e 100644
--- a/src/.gitignore
+++ b/src/.gitignore
@@ -2,4 +2,3 @@
 .echocheck
 TAGS*
 bin*
-config-local.h
diff --git a/src/Makefile.housekeeping b/src/Makefile.housekeeping
index 2ab842e..f8b9c45 100644
--- a/src/Makefile.housekeeping
+++ b/src/Makefile.housekeeping
@@ -364,7 +364,7 @@ endef
 define obj_template
 
 	@$(CPP) $(CFLAGS) $(CFLAGS_$(3)) $(CFLAGS_$(4)) -DOBJECT=$(4) \
-		-Wno-error -MM $(1) -MT "$(4)_DEPS" -MG -MP | \
+		-Wno-error -M $(1) -MT "$(4)_DEPS" -MG -MP | \
 		sed 's/_DEPS\s*:/_DEPS =/' >> $(2)
 	@$(ECHO_E) '\n$$(BIN)/$(4).o : $(1) $$(MAKEDEPS) $$($(4)_DEPS)' \
 		 '\n\t$$(QM)$(ECHO) "  [BUILD] $$@"' \
@@ -745,6 +745,13 @@ CLEANUP += $(EFIROM)
 
 ###############################################################################
 #
+# Local configs
+#
+config/local/%.h :
+	$(Q)touch $@
+
+###############################################################################
+#
 # Auto-incrementing build serial number.  Append "bs" to your list of
 # build targets to get a serial number printed at the end of the
 # build.  Enable -DBUILD_SERIAL in order to see it when the code runs.
diff --git a/src/config/console.h b/src/config/console.h
index b4ea1dd..deef5eb 100644
--- a/src/config/console.h
+++ b/src/config/console.h
@@ -18,4 +18,6 @@
 //#define	CONSOLE_BTEXT		/* Who knows what this does? */
 //#define	CONSOLE_PC_KBD		/* Direct access to PC keyboard */
 
+#include <config/local/console.h>
+
 #endif /* CONFIG_CONSOLE_H */
diff --git a/src/config/general.h b/src/config/general.h
index 04b5bef..c40c31c 100644
--- a/src/config/general.h
+++ b/src/config/general.h
@@ -120,4 +120,6 @@
 #undef	GDBUDP			/* Remote GDB debugging over UDP
 				 * (both may be set) */
 
+#include <config/local/general.h>
+
 #endif /* CONFIG_GENERAL_H */
diff --git a/src/config/ioapi.h b/src/config/ioapi.h
index 7726a0f..00020c0 100644
--- a/src/config/ioapi.h
+++ b/src/config/ioapi.h
@@ -12,4 +12,6 @@
 //#undef	PCIAPI_PCBIOS		/* Access via PCI BIOS */
 //#define	PCIAPI_DIRECT		/* Direct access via Type 1 accesses */
 
+#include <config/local/ioapi.h>
+
 #endif /* CONFIG_IOAPI_H */
diff --git a/src/config/isa.h b/src/config/isa.h
index 523be1c..e2a0505 100644
--- a/src/config/isa.h
+++ b/src/config/isa.h
@@ -12,4 +12,6 @@
 #undef	ISA_PROBE_ADDRS		/* e.g. 0x200, 0x300 */
 #undef	ISA_PROBE_ONLY		/* Do not probe any other addresses */
 
+#include <config/local/isa.h>
+
 #endif /* CONFIG_ISA_H */
diff --git a/src/config/nap.h b/src/config/nap.h
index 8648d92..65d479b 100644
--- a/src/config/nap.h
+++ b/src/config/nap.h
@@ -12,4 +12,6 @@
 //#undef		NAP_PCBIOS
 //#define		NAP_NULL
 
+#include <config/local/nap.h>
+
 #endif /* CONFIG_NAP_H */
diff --git a/src/config/serial.h b/src/config/serial.h
index 984a7a9..b52f4ba 100644
--- a/src/config/serial.h
+++ b/src/config/serial.h
@@ -25,4 +25,6 @@
 #define	COMSTOP		1		/* Stop bits */
 #endif
 
+#include <config/local/serial.h>
+
 #endif /* CONFIG_SERIAL_H */
diff --git a/src/config/timer.h b/src/config/timer.h
index 7c3f352..b649af5 100644
--- a/src/config/timer.h
+++ b/src/config/timer.h
@@ -12,4 +12,6 @@
 //#undef		TIMER_PCBIOS
 //#define		TIMER_RDTSC
 
+#include <config/local/timer.h>
+
 #endif /* CONFIG_TIMER_H */
diff --git a/src/config/umalloc.h b/src/config/umalloc.h
index de4019e..1da6a0c 100644
--- a/src/config/umalloc.h
+++ b/src/config/umalloc.h
@@ -9,4 +9,6 @@
 
 #include <config/defaults.h>
 
+#include <config/local/umalloc.h>
+
 #endif /* CONFIG_UMALLOC_H */
-- 
2.1.0

